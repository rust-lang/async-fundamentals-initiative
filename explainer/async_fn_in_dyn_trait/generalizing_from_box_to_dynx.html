<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Generalizing from box to dynx - async fn fundamentals initiative</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../index.html">üëã Welcome</a></li><li class="chapter-item "><a href="../../updates.html">‚úèÔ∏è Updates</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../updates/2021-oct.html">2021-Oct</a></li></ol></li><li class="chapter-item "><a href="../../CHARTER.html">üìú Charter</a></li><li class="chapter-item "><a href="../../stakeholders.html">üë™ Stakeholders</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../stakeholders/2021-nov.html">2021-Nov</a></li></ol></li><li class="chapter-item "><a href="../../roadmap.html">üõ£ Roadmap</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../roadmap/static_async_trait.html">üí¨ Static async trait</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../roadmap/static_async_trait_mvp.html">MVP: Static async fn in traits</a></li></ol></li><li class="chapter-item "><a href="../../roadmap/impl_trait_in_traits.html">üí¨ impl Trait in traits</a></li><li class="chapter-item "><a href="../../roadmap/dyn_async_trait.html">üí¨ Dyn async trait</a></li><li class="chapter-item "><a href="../../roadmap/dyn_trait.html">üí§ Dyn trait</a></li><li class="chapter-item "><a href="../../roadmap/async_drop.html">üí§ Async drop</a></li><li class="chapter-item "><a href="../../roadmap/async_closures.html">üí§ Async closures</a></li></ol></li><li class="chapter-item "><a href="../../evaluation.html">üî¨ Evaluation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../evaluation/executor-styles.html">Executor styles</a></li><li class="chapter-item "><a href="../../evaluation/scenarios.html">Reference scenarios</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../evaluation/scenarios/background-logging.html">Background logging</a></li><li class="chapter-item "><a href="../../evaluation/scenarios/implementing-async-read.html">Implementing AsyncRead</a></li><li class="chapter-item "><a href="../../evaluation/scenarios/dyn.html">Dyn</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../evaluation/scenarios/dyn/embedded-consume.html">Embedded system consuming general purpose libraries</a></li><li class="chapter-item "><a href="../../evaluation/scenarios/dyn/inner-loop.html">Performance-sensitive inner loop with dynamic dispatch</a></li><li class="chapter-item "><a href="../../evaluation/scenarios/dyn/taking-ownership.html">Taking ownership of the receiver</a></li><li class="chapter-item "><a href="../../evaluation/scenarios/dyn/async-drop.html">Async drop</a></li><li class="chapter-item "><a href="../../evaluation/scenarios/dyn/embedded-async-drop.html">Embedded async drop</a></li></ol></li><li class="chapter-item "><a href="../../evaluation/scenarios/async-fn-in-traits.html">Reference scenarios</a></li></ol></li><li class="chapter-item "><a href="../../evaluation/challenges.html">Challenges</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../evaluation/challenges/bounding_futures.html">Bounding futures</a></li><li class="chapter-item "><a href="../../evaluation/challenges/naming_futures.html">Naming futures</a></li><li class="chapter-item "><a href="../../evaluation/challenges/dyn_traits.html">Dyn traits</a></li><li class="chapter-item "><a href="../../evaluation/challenges/bounding_async_drop.html">Bounding async drop</a></li><li class="chapter-item "><a href="../../evaluation/challenges/guaranteeing_async_drop.html">Guaranteeing async drop</a></li><li class="chapter-item "><a href="../../evaluation/challenges/implicit_await_with_async_drop.html">Implicit await with async drop</a></li></ol></li><li class="chapter-item "><a href="../../evaluation/design.html">Design documents</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../evaluation/design/implied_send.html">Implied Send</a></li><li class="chapter-item "><a href="../../evaluation/design/trait_multiplication.html">Trait multiplication</a></li><li class="chapter-item "><a href="../../evaluation/design/inline_async_fn.html">Inline async fn</a></li><li class="chapter-item "><a href="../../evaluation/design/custom_dyn_impls.html">Custom dyn impls</a></li><li class="chapter-item "><a href="../../evaluation/design/auto_traits_consider_async_drop.html">Auto traits consider AsyncDrop</a></li><li class="chapter-item "><a href="../../evaluation/design/simple_names.html">Simple names</a></li><li class="chapter-item "><a href="../../evaluation/design/bound_items.html">Bound items</a></li><li class="chapter-item "><a href="../../evaluation/design/with_clauses.html">With clauses</a></li><li class="chapter-item "><a href="../../evaluation/design/dynx.html">Dynx trait</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../evaluation/design/dynx/creation.html">Creation</a></li><li class="chapter-item "><a href="../../evaluation/design/dynx/auto_trait.html">With auto traits</a></li><li class="chapter-item "><a href="../../evaluation/design/dynx/sealed_traits.html">Sealed traits</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../explainer.html">üìö Explainer</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../explainer/async_fn_in_traits.html">Async fn in traits</a></li><li class="chapter-item expanded "><a href="../../explainer/async_fn_in_dyn_trait.html">Async fn in dyn trait</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/how_it_feels.html">How it feels to use</a></li><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/avoiding_allocation.html">Using dyn without allocation</a></li><li class="chapter-item expanded "><a href="../../explainer/async_fn_in_dyn_trait/how_it_works.html">How it works</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/hardcoding_box.html">Hardcoding box</a></li><li class="chapter-item expanded "><a href="../../explainer/async_fn_in_dyn_trait/generalizing_from_box_to_dynx.html" class="active">Generalizing from box to dynx</a></li><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/identity_shim_functions.html">Identity shim functions</a></li><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/nested_impl_trait.html">Nested impl Trait</a></li><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/unresolved.html">Unresolved questions</a></li></ol></li><li class="chapter-item "><a href="../../explainer/async_fn_in_dyn_trait/future_possibilities.html">Future possibilities</a></li></ol></li><li class="chapter-item "><a href="../../explainer/user_facing_summary.html">Appendix: Summary of user-facing extensions</a></li><li class="chapter-item "><a href="../../explainer/implementation_plan.html">Appendix: Implementation plan</a></li><li class="chapter-item "><a href="../../explainer/inline_async_iter_adapter.html">Appendix: Inline async iter adapter</a></li></ol></li><li class="chapter-item "><a href="../../RFC.html">‚ú® RFC</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../RFC/static_async_fn_in_traits.html">Static async fn in traits</a></li><li class="chapter-item "><a href="../../RFC/refined_impls.html">Refined trait impls</a></li></ol></li><li class="chapter-item "><a href="../../FAQ.html">üòï FAQ</a></li><li class="chapter-item "><a href="../../archive.html">Archive</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../archive/2021-phase_1.html">2021: Phase 1</a></li><li class="chapter-item "><a href="../../archive/2021-phase_1_narrative.html">2021: Phase 1 narrative</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">async fn fundamentals initiative</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/async-fundamentals-initiative" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/async-fundamentals-initiative/edit/master/./explainer/async_fn_in_dyn_trait/generalizing_from_box_to_dynx.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="generalizing-from-box-with-dynx-structs"><a class="header" href="#generalizing-from-box-with-dynx-structs">Generalizing from box with dynx structs</a></h1>
<p><img src="https://img.shields.io/badge/status-draft%20rfc-informational" alt="planning rfc" /></p>
<p>So far our design has hardcoded the use of <code>Box</code> in the vtable. We can generalize this by introducing a new concept into the compiler; we currently call this a &quot;dynx type&quot;<sup class="footnote-reference"><a href="#better-name">1</a></sup>. Like closure types, dynx types are anonymous structs introduced by the compiler. Instead of returning a <code>Pin&lt;Box&lt;dyn Future&gt;&gt;</code>, the <code>next</code> function will return a <code>dynx Trait</code>, which represents &quot;some kind of pointer to a <code>dyn Trait</code>&quot;. <strong>Note that the <code>dynx Trait</code> types are anonymous and that the <code>dynx</code> syntax we are using here is for explanatory purposes only.</strong> Users still work with pointer types like <code>&amp;dyn Trait</code> , <code>&amp;mut dyn Trait</code>, etc.<sup class="footnote-reference"><a href="#user-facing">2</a></sup></p>
<div class="footnote-definition" id="better-name"><sup class="footnote-definition-label">1</sup>
<p>Obviously the name &quot;dynx type&quot; is not great. We were considering &quot;object type&quot; (with e.g. <code>obj Trait</code> as the explanatory syntax) but we're not sure what to use here.
<sup class="footnote-reference"><a href="#user-facing">2</a></sup>: It may make sense to use <code>dynx</code> as the basis for a user-facing feature at some point, but we are not proposing that here.</p>
</div>
<p>At runtime, a <code>dynx Trait</code> struct has the same size as a <code>Box&lt;dyn Trait&gt;</code> (two machine words). If a <code>dynx Trait</code> were an ordinary struct, it might look like this:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct dynx Trait {
    data: *mut (),
    vtable: *mut (),
}
<span class="boring">}
</span></code></pre></pre>
<p>Like a <code>Box&lt;dyn Trait&gt;</code>, it carries a vtable that lets us invoke the methods from <code>Trait</code> dynamically. Unlike a <code>Box&lt;dyn Trait&gt;</code>, it does not hardcode the memory allocation strategy. <strong>Instead, a dynx vtable repurposes the &quot;drop&quot; function slot to mean &quot;drop this pointer and its contents&quot;.</strong> This allows <code>dynx Trait</code> types to be created from any kind of pointer, such as a <code>Box</code>, <code>&amp;</code>, <code>&amp;mut</code>, <code>Rc</code>, or <code>Arc</code>. When a <code>dynx Trait</code> struct is dropped, it invokes this drop function from its destructor:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Drop for dynx Trait {
    fn drop(&amp;mut self) {
       let drop_fn: fn(*mut ()) = self.vtable.drop_fn;
       drop_fn(self.data);
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="using-dynx-in-the-vtable"><a class="header" href="#using-dynx-in-the-vtable">Using dynx in the vtable</a></h2>
<p>Now that we have <code>dynx</code>, we can define the vtable for an <code>AsyncIterator</code> almost exactly like we saw before, but using <code>dynx Future</code> instead of a pinned box:</p>
<pre><pre class="playground"><code class="language-rust=">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct AsyncIteratorVtable&lt;I&gt; {
    ..., /* some stuff */
    next: fn(&amp;mut ()) -&gt; dynx Future&lt;Output = Option&lt;I&gt;&gt;
    //                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //                   Look ma, no box!
}
<span class="boring">}
</span></code></pre></pre>
<p>Calling <code>i.next()</code> for some <code>i: &amp;mut dyn AsyncIterator</code> will now give back a <code>dynx</code> result:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>i.next().await

// becomes

let f: dynx Future&lt;Output = Option&lt;I&gt;&gt; = i.next();
f.await
<span class="boring">}
</span></code></pre></pre>
<p>When the dynx <code>f</code> is dropped, its destructor will call the destructor from the vtable, freeing the backing memory in whatever way is appropriate for the kind of pointer that the <code>dynx</code> was constructed from.</p>
<p><strong>What have we achieved?</strong> By using <code>dynx</code> in the vtable, we have made it so that the caller doesn't know (or have to know) what memory management strategy is in use for the resulting trait object. It knows that it has an instance of some struct (<code>dynx Future</code>, specifically) that implements <code>Future</code>, is 2-words in size, and can be dropped in the usual way. </p>
<h2 id="the-shim-function-builds-the-dynx"><a class="header" href="#the-shim-function-builds-the-dynx">The shim function builds the dynx</a></h2>
<p>In the previous section, we saw that using <code>dynx</code> in the vtable means that the caller no longer knows (or cares) what memory management strategy is in use. This section explains how the callee actually constructs the <code>dynx</code> that gets returned (and how impls can tweak that construction to choose the memory management strategy they want).</p>
<p>Absent any other changes, the <code>impl</code> of <code>AsyncIter</code> contains an <code>async fn next()</code> that returns an <code>impl Future</code> which could have any size. Therefore, to construct a <code>dynx Future</code>, we are going to need an adaptive shim, just like we used in the <code>Pin&lt;Box&gt;</code> example. In fact, the default shim is almost exactly the same as we saw in that case. It allocates a pinned box to store the future and returns it. The main difference is that it converts this <code>Pin&lt;Box&lt;T&gt;&gt;</code> into a <code>dynx Future</code> before returning, rather than coercing to a <code>Pin&lt;Box&lt;dyn Future&gt;&gt;</code> return type (the next section will cover shim functions that don't allocate a box):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// &quot;pseudocode&quot;, you couldn't actually write this because there is no
// user-facing syntax for the `dynx Future` type

fn yielding_range_shim(
    this: &amp;mut YieldingRangeIterator,
) -&gt; dynx Future&lt;Output = Option&lt;u32&gt;&gt; {
    let boxed = Box::pin(&lt;YieldingRangeIterator as AsyncIterator&gt;::next(this));
    
    // invoke the (inherent) `new` method that converts to a `dynx Future`
    &lt;dynx Future&gt;::new(boxed)
}
<span class="boring">}
</span></code></pre></pre>
<p>The most interesting part of this function is the last line, which construct the <code>dynx Future</code> from its <code>new</code> function. Intuitively, the <code>new</code> function takes one argument, which must implement the trait <code>IntoRawPointer</code> (added by this design). The <code>IntoRawPointer</code> trait is implemented for smart pointer types int the standard library, like <code>Box</code>, <code>Pin&lt;Box&gt;</code>, and <code>Rc</code>, and represents &quot;some kind of pointer&quot; as well as &quot;how to drop that pointer&quot;:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Not pseudocode, will be added to the stdlib and implemented
// by various types, including `Box` and `Pin&lt;Box&gt;`.

unsafe trait IntoRawPointer: Deref {
    /// Convert this pointer into a raw pointer to `Self::Target`. 
    ///
    /// This raw pointer must be valid to dereference until `drop_raw` (below) is invoked;
    /// this trait is unsafe because the impl must ensure that to be true.
    fn into_raw(self) -&gt; *mut Self::Target;
    
    /// Drops the smart pointer itself as well as the contents of the pointer.
    /// For example, when `Self = Box&lt;T&gt;`, this will free the box as well as the
    /// `T` value.
    unsafe fn drop_raw(this: *mut Self::Target);
}
<span class="boring">}
</span></code></pre></pre>
<p>The <code>&lt;dynx Future&gt;::new</code> method just takes a parameter of type <code>impl IntoRawPointer</code> and invokes <code>into_raw</code> to convert it into a raw pointer. This raw pointer is then packaged up, together with a modified vtable for <code>Future</code>, into the <code>dynx</code> structure. The modified vtable is the same as a normal <code>Future</code> vtable, except that the &quot;drop&quot; slot is modified so that its drop function points to <code>IntoRawPointer::drop_raw</code>, which will be invoked on the data pointer when the <code>dynx</code> is dropped. In pseudocode, it looks like this:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// &quot;pseudocode&quot;, you couldn't actually write this because there is no
// user-facing syntax for the `dynx Future` type; but conceptually this
// inherent function exists (in the actual implementation, it may be inlined
// by the compiler, since you could never name it

struct dynx Future&lt;O&gt; {
    data: *mut (),   // underlying data pointer
    vtable: &amp;'static FutureVtable&lt;O&gt;, // &quot;modified&quot; vtable for `Future&lt;Output = O&gt;` for the underlying type
}

struct FutureVtable&lt;O&gt; {
    /// Invokes `Future::poll` on the underlying data.
    ///
    /// Unsafe condition: Expects the output from `IntoRawPointer::into_raw`
    /// which must not have already been freed.
    poll_fn: unsafe fn(*mut (), cx: &amp;mut Context&lt;'_&gt;) -&gt; Ready&lt;()&gt;,
    
    /// Frees the memory for the pointer to future.
    ///
    /// Unsafe condition: Expects the output from `IntoRawPointer::into_raw`
    /// which must not have already been freed.
    drop_fn: unsafe fn(*mut ()),
}

impl&lt;O&gt; dynx Future&lt;Output = O&gt; {
    fn new&lt;RP&gt;(from: RP)
    where
        RP: IntoRawPointer,
        RP::Target: Sized,               // This must be sized so that we know we have a thin pointer.
        RP::Target: Future&lt;Output = O&gt;,  // The target must implement the future trait.
        RP: Unpin,                       // Required because `Future` has a `Pin&lt;&amp;mut Self&gt;` method, see discussion later.
    {
        let data = IntoRawPointer::into_raw(from);
        let vtable = FutureVtable&lt;O&gt; {
            poll_fn: &lt;RP::Target as Future&gt;::poll,
            drop_fn: |ptr| RP::drop_raw(ptr),
        }; // construct vtable
        dynx Future {
            data, vtable
        }
    }
}

impl&lt;O&gt; Future for dynx Future&lt;Output = O&gt; {
    type Output = O;
    
    fn poll(
        self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut Context&lt;'_&gt;,
    ) -&gt; Ready&lt;()&gt; {
        // Unsafety condition is met since...
        // 1. self.data was initialized in new and is otherwise never changed.
        // 2. drop must not yet have run or else self would not exist.
        unsafe {
            // Conceptually...
            let pin: Pin&lt;RP&gt; = Pin::new(self); // requires `RP: Unpin`.
            let pin_mut_self: Pin&lt;&amp;mut RP::Target&gt; = pin.as_mut();
            self.vtable.poll_fn(pin_mut_self, cx);
            self = pin.into_inner(); // XXX is this quite right?
            
            self.vtable.poll_fn(self.data, cx)
        }
    }
}


impl&lt;O&gt; Drop for dynx Future&lt;Output = O&gt; {
    fn drop(&amp;mut self) {
        // Unsafety condition is met since...
        // 1. self.data was initialized in new and is otherwise never changed.
        // 2. drop must not yet have run or else self would not exist.
        unsafe {
            self.vtable.drop_fn(self.data);
        }
    }
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../explainer/async_fn_in_dyn_trait/hardcoding_box.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../explainer/async_fn_in_dyn_trait/identity_shim_functions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../explainer/async_fn_in_dyn_trait/hardcoding_box.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../explainer/async_fn_in_dyn_trait/identity_shim_functions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
