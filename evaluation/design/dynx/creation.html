<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Creation - async fn fundamentals initiative</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../index.html">üëã Welcome</a></li><li class="chapter-item "><a href="../../../updates.html">‚úèÔ∏è Updates</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../updates/2021-oct.html">2021-Oct</a></li></ol></li><li class="chapter-item "><a href="../../../CHARTER.html">üìú Charter</a></li><li class="chapter-item "><a href="../../../stakeholders.html">üë™ Stakeholders</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../stakeholders/2021-nov.html">2021-Nov</a></li></ol></li><li class="chapter-item "><a href="../../../roadmap.html">üõ£ Roadmap</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../roadmap/static_async_trait.html">üí¨ Static async trait</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../roadmap/static_async_trait_mvp.html">MVP: Static async fn in traits</a></li></ol></li><li class="chapter-item "><a href="../../../roadmap/impl_trait_in_traits.html">üí¨ impl Trait in traits</a></li><li class="chapter-item "><a href="../../../roadmap/dyn_async_trait.html">üí¨ Dyn async trait</a></li><li class="chapter-item "><a href="../../../roadmap/dyn_trait.html">üí§ Dyn trait</a></li><li class="chapter-item "><a href="../../../roadmap/async_drop.html">üí§ Async drop</a></li><li class="chapter-item "><a href="../../../roadmap/async_closures.html">üí§ Async closures</a></li></ol></li><li class="chapter-item expanded "><a href="../../../evaluation.html">üî¨ Evaluation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../evaluation/executor-styles.html">Executor styles</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios.html">Reference scenarios</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../evaluation/scenarios/background-logging.html">Background logging</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios/implementing-async-read.html">Implementing AsyncRead</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios/dyn.html">Dyn</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../evaluation/scenarios/dyn/embedded-consume.html">Embedded system consuming general purpose libraries</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios/dyn/inner-loop.html">Performance-sensitive inner loop with dynamic dispatch</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios/dyn/taking-ownership.html">Taking ownership of the receiver</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios/dyn/async-drop.html">Async drop</a></li><li class="chapter-item "><a href="../../../evaluation/scenarios/dyn/embedded-async-drop.html">Embedded async drop</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../evaluation/challenges.html">Challenges</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../evaluation/challenges/bounding_futures.html">Bounding futures</a></li><li class="chapter-item "><a href="../../../evaluation/challenges/naming_futures.html">Naming futures</a></li><li class="chapter-item "><a href="../../../evaluation/challenges/dyn_traits.html">Dyn traits</a></li><li class="chapter-item "><a href="../../../evaluation/challenges/bounding_async_drop.html">Bounding async drop</a></li><li class="chapter-item "><a href="../../../evaluation/challenges/guaranteeing_async_drop.html">Guaranteeing async drop</a></li><li class="chapter-item "><a href="../../../evaluation/challenges/implicit_await_with_async_drop.html">Implicit await with async drop</a></li></ol></li><li class="chapter-item expanded "><a href="../../../evaluation/design.html">Design documents</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../evaluation/design/implied_send.html">Implied Send</a></li><li class="chapter-item "><a href="../../../evaluation/design/trait_multiplication.html">Trait multiplication</a></li><li class="chapter-item "><a href="../../../evaluation/design/inline_async_fn.html">Inline async fn</a></li><li class="chapter-item "><a href="../../../evaluation/design/custom_dyn_impls.html">Custom dyn impls</a></li><li class="chapter-item "><a href="../../../evaluation/design/auto_traits_consider_async_drop.html">Auto traits consider AsyncDrop</a></li><li class="chapter-item "><a href="../../../evaluation/design/simple_names.html">Simple names</a></li><li class="chapter-item "><a href="../../../evaluation/design/bound_items.html">Bound items</a></li><li class="chapter-item "><a href="../../../evaluation/design/with_clauses.html">With clauses</a></li><li class="chapter-item expanded "><a href="../../../evaluation/design/dynx.html">Dynx trait</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../evaluation/design/dynx/creation.html" class="active">Creation</a></li><li class="chapter-item "><a href="../../../evaluation/design/dynx/auto_trait.html">With auto traits</a></li><li class="chapter-item "><a href="../../../evaluation/design/dynx/sealed_traitsmd.html">Sealed traits</a></li></ol></li></ol></li></ol></li><li class="chapter-item "><a href="../../../explainer.html">üìö Explainer</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../explainer/async_fn_in_traits.html">Async fn in traits</a></li><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait.html">Async fn in dyn trait</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/how_it_feels.html">How it feels to use</a></li><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/avoiding_allocation.html">Using dyn without allocation</a></li><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/how_it_works.html">How it works</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/hardcoding_box.html">Hardcoding box</a></li><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/generalizing_from_box_to_dynx.html">Generalizing from box to dynx</a></li><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/identity_shim_functions.html">Identity shim functions</a></li><li class="chapter-item "><a href="../../../explainer/async_fn_in_dyn_trait/unresolved.html">Unresolved questions</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../explainer/user_facing_summary.html">Appendix: Summary of user-facing extensions</a></li><li class="chapter-item "><a href="../../../explainer/implementation_plan.html">Appendix: Implementation plan</a></li><li class="chapter-item "><a href="../../../explainer/inline_async_iter_adapter.html">Appendix: Inline async iter adapter</a></li></ol></li><li class="chapter-item "><a href="../../../RFC.html">‚ú® RFC</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../RFC/static_async_fn_in_traits.html">Static async fn in traits</a></li></ol></li><li class="chapter-item "><a href="../../../FAQ.html">üòï FAQ</a></li><li class="chapter-item "><a href="../../../archive.html">Archive</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../archive/2021-phase_1.html">2021: Phase 1</a></li><li class="chapter-item "><a href="../../../archive/2021-phase_1_narrative.html">2021: Phase 1 narrative</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">async fn fundamentals initiative</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/async-fundamentals-initiative" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/async-fundamentals-initiative/edit/master/./evaluation/design/dynx/creation.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-do-you-create-a-dynx"><a class="header" href="#how-do-you-create-a-dynx">How do you create a dynx?</a></h1>
<p>In the previous section, we showed how a <code>#[dyn(identity)]</code> function must return &quot;something that can be converted into a dynx struct&quot;, and we showed that a case of returning a <code>Pin&lt;Box&lt;impl Future, A&gt;&gt;</code> type. But what are the general rules for constructing a <code>dynx</code> struct? You're asking the right question, but that's a part of the design we haven't bottomed out yet.</p>
<p>In short, there are two &quot;basic&quot; approaches we could take. One of them is more conservative, in that it doesn't change much about Rust today, but it's also much more complex, because <code>dyn</code> dealing with all the &quot;corner cases&quot; of <code>dyn</code> is kind of complicated. The other is more radical, but may result in an overall smoother, more coherent design.</p>
<p>Apart from that tantalizing tidbit, we are intentionally not providing the details here, because this document is long enough as it is! The next document dives into this question, along with a related question, which is how <code>dynx</code> and sealed traits interact.</p>
<p>This is actually a complex question with (at least) two possible answers.</p>
<h2 id="alternative-a-p-must-deref-to-something-that-implements-bounds"><a class="header" href="#alternative-a-p-must-deref-to-something-that-implements-bounds">Alternative A: P must deref to something that implements Bounds</a></h2>
<p>The pointer type <code>P</code> must implement <code>IntoRawPointer</code> (along with various other criteria) and its referent must implement <code>Bounds</code>.</p>
<h3 id="intorawpointer-trait"><a class="header" href="#intorawpointer-trait">IntoRawPointer trait</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Not pseudocode, will be added to the stdlib and implemented
// by various types, including `Box` and `Pin&lt;Box&gt;`.

unsafe trait IntoRawPointer: Deref {
    /// Convert this pointer into a raw pointer to `Self::Target`. 
    ///
    /// This raw pointer must be valid to dereference until `drop_raw` (below) is invoked;
    /// this trait is unsafe because the impl must ensure that to be true.
    fn into_raw(self) -&gt; *mut Self::Target;
    
    /// Drops the smart pointer itself as well as the contents of the pointer.
    /// For example, when `Self = Box&lt;T&gt;`, this will free the box as well as the
    /// `T` value.
    unsafe fn drop_raw(this: *mut Self::Target);
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="other-conditions-pointer-must-meet"><a class="header" href="#other-conditions-pointer-must-meet">Other conditions pointer must meet</a></h3>
<ul>
<li>Must be <code>IntoRawPointer</code> which ensures:
<ul>
<li><code>Deref</code> and <code>DerefMut</code> are stable, side-effect free and all that</li>
<li>they deref to the same memory as <code>into_raw</code></li>
</ul>
</li>
<li>If <code>Bounds</code> includes a <code>&amp;mut self</code> method, <code>P</code> must be <code>DerefMut</code></li>
<li>If <code>Bounds</code> includes a <code>&amp;self</code> method, <code>P</code> must be <code>Deref</code></li>
<li>If <code>Bounds</code> includes <code>Pin&lt;&amp;mut Self&gt;</code>, <code>P</code> must be <code>Unpin</code> ... and ... something something <code>DerefMut</code>? how do you get from <code>Pin&lt;P&gt;</code> to <code>Pin&lt;&amp;mut P::Target&gt;</code>?</li>
<li>If <code>Bounds</code> includes <code>Pin&lt;&amp;Self&gt;</code>, <code>P</code> must be <code>Unpin</code> ... and ... something something <code>DerefMut</code>? how do you get from <code>Pin&lt;P&gt;</code> to <code>Pin&lt;&amp;mut P::Target&gt;</code>?</li>
<li>If <code>Bounds</code> includes an auto trait <code>AutoTrait</code>, <code>P</code> must implement <code>AutoTrait</code>
<ul>
<li>and: <code>dynx Bounds</code> implements the auto trait <code>AutoTrait</code> (in general, <code>dynx Bounds</code> implements all of <code>Bounds</code>)</li>
</ul>
</li>
<li><code>Bounds</code> must be &quot;dyn safe&quot;</li>
</ul>
<h2 id="alternative-b-p-must-implement-bounds"><a class="header" href="#alternative-b-p-must-implement-bounds">Alternative B: P must implement Bounds</a></h2>
<p>Alternatively, we could declare that the pointer type P must implement <code>Bounds</code>. This is much simpler to express, but it has some issues. For example, if you have</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait Foo { 

}
<span class="boring">}
</span></code></pre></pre>
<p>then we could not construct a <code>dynx Foo</code> from a <code>Box&lt;dyn Foo&gt;</code> because there is no <code>impl Foo for Box&lt;dyn Foo&gt;</code>. It would be nice if those impls could be added automatically or at least more easily.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Not pseudocode, will be added to the stdlib and implemented
// by various types, including `Box` and `Pin&lt;Box&gt;`.

unsafe trait IntoRawPointer: Deref {
    /// Convert this pointer into a raw pointer to `Self::Target`. 
    ///
    /// This raw pointer must be valid to dereference until `drop_raw` (below) is invoked;
    /// this trait is unsafe because the impl must ensure that to be true.
    fn into_raw(self) -&gt; *mut Self::Target;
    
    /// These methods would be used by compiler to convert back so we can invoke the original
    /// impls.
    unsafe fn from_ref(this: &amp;*mut Self::Target) -&gt; &amp;Self;
    unsafe fn from_mut_ref(this: &amp;mut *mut Self::Target) -&gt; &amp;mut Self;
    ...

    /// Drops the smart pointer itself as well as the contents of the pointer.
    /// For example, when `Self = Box&lt;T&gt;`, this will free the box as well as the
    /// `T` value.
    unsafe fn drop_raw(this: *mut Self::Target);
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../evaluation/design/dynx.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../../evaluation/design/dynx/auto_trait.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../evaluation/design/dynx.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../evaluation/design/dynx/auto_trait.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
